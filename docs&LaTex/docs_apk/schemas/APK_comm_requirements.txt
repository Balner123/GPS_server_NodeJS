===================================
APK Communication Requirements
===================================

1) Auth & Session
------------------
- APK klient využívá existující login endpoint (`POST /api/apk/login`).
- Účet musí být ověřený (flag `user.is_verified=true`), jinak login vrací `403`.
- Session cookie je potřeba pro uživatelské akce (registrace, logout). 
- Telemetrie a Handshake primárně využívají `device_id`, ale pokud je session cookie dostupná, je odesílána také.
- Logout (`POST /api/apk/logout`) ruší session.

2) Registrace zařízení
----------------------
- Endpoint: `POST /api/devices/register` (sjednocený).
- Payload:
  {
    "client_type": "APK",
    "device_id": "GUID/UUID",
    "name": "Device Model Name"
  }
- Server ověřuje session a mapuje ID na zařízení.

3) Handshake / Konfigurace
--------------------------
- Endpoint: `POST /api/devices/handshake`.
- Účel: Synchronizace konfigurace a správa stavu (Power State).
- Spouštění:
  1. Při startu služby (asynchronně).
  2. Periodicky (např. každých 15 min).
  3. Po dokončení odesílání dávky dat (pro okamžité potvrzení příkazů).
- Payload:
  {
    "device_id": "...",
    "client_type": "APK",
    "power_status": "ON|OFF",
    "reason": "service_start|periodic|sync_complete|manual"
  }
- Response:
  {
    "registered": true,
    "config": { "interval_gps": 60, "interval_send": 1 },
    "power_instruction": "NONE|TURN_OFF"
  }
- Klient musí respektovat `power_instruction="TURN_OFF"` zastavením služby.

4) Telemetrie (Data Input)
--------------------------
- Endpoint: `POST /api/devices/input`.
- Zpracování: SyncWorker čte data z SQLite DB.
- Formát (Batch Array):
  [
    {
      "device": "device_id",
      "latitude": 50.123,
      "longitude": 14.456,
      "timestamp": "ISO8601",
      "power_status": "ON",
      "client_type": "APK",
      "speed": 0.0,
      "accuracy": 10.5
    },
    ...
  ]
- Odpověď serveru:
  { "success": true, ... }
  - Obsahuje-li odpověď novou konfiguraci, klient ji uloží (stejně jako u Handshake).

5) Error Handling
-----------------
- 401/403: Zneplatnění session -> Logout broadcast.
- 404 (Not Registered): Zastavení služby, vyžaduje novou registraci.
- 500+: Retry politika (Worker Manager exponential backoff).

6) Lokální ukládání (Store-and-Forward)
---------------------------------------
- Data se ukládají do `LocationDao` (SQLite).
- Limit dávky: Typicky 50 záznamů na jeden request.
- Data se mažou až po potvrzení (200 OK) od serveru.
- Při chybě (Network/Server) data zůstávají v DB pro další pokus.