====================================
PLAN: Stabilni handshake serveru s HW
====================================

1) Shrnutí současného stavu
---------------------------
- HW zařízení odesílá data (JSON nebo pole JSON objektů) na POST /api/devices/input.
- Middleware authenticateDevice vyhledá device podle device_id, při neúspěchu vrací 404.
- Kontroler handleDeviceInput zapíše nové lokace, aktualizuje last_seen a odpovídá pouze konfigurací (intervaly, počet satelitů).
- Žádná vrstva neukládá stav napájení ani pending instrukce, komunikace je jednosměrná (data -> odpověď s konfigurací).
- HW registrace probíhá zvlášť na POST /api/hw/register-device, bez návaznosti na běžný provoz.

2) Požadovaný handshake (high-level)
------------------------------------
Fáze A: HW → server (registration&status_check)
  • Payload musí obsahovat alespoň device_id, aktuální power_status.
  • Server ověří registraci, případně vrátí registered=false.
  • Pokud je zařízení známé, server aktualizuje Device.power_status na hodnotu, kterou HW hlásí (pokud se liší a instrukce je NONE). 

Fáze B: server → HW
  • Server vrátí konfigurační blok (interval_gps, interval_send, atd.).
  • Přidá nové pole power_instruction (NONE|TURN_OFF).

Fáze C: HW → server (data + ack)
  • HW odesílá standardní GPS data na /api/devices/input (stejné rozhraní) s novými poli: power_instruction_ack (instruction_id) a volitelně aktuální power_status.
  • Server po zpracování dat zruší instrukci (power_instruction=NONE) a nastaví POWER_STATUS --> instrukce požaduje vypnutí proto status=OFF

3) Úpravy backendu (server.js + controllers + modely)
----------------------------------------------------
- Schéma DB:
  • Device: přidat sloupce power_status (ENUM('ON','OFF'), default 'ON'),
             power_instruction (ENUM('NONE','TURN_OFF'), default 'NONE'),
             instruction_token (STRING), power_instruction_updated_at (DATETIME), last_power_ack_at (DATETIME).
- Model Device (models/device.js): promítnout nové atributy (Sequelize ENUM/STRING + default hodnoty).
- Kontroler deviceController:
  • Nový handler handleDeviceHandshake (POST /api/devices/handshake) – vstup registrace/status, výstup konfigurace + instrukce (sdílené i pro APK).
  • Rozšířit handleDeviceInput: číst ack, aktualizovat last_power_ack_at, nulovat power_instruction / instruction_token, případně synchronizovat power_status.
  • Zvážit společnou pomocnou funkci buildDeviceConfigPayload(device).
- Trasa routes/devices.api.js: přidat POST /handshake & POST /register (sjednocené API) + legacy delegace v routes/hw.api.js.
- Middleware authenticateDevice: ponechat, jen umožnit čtení power instrukcí přes req.device.
- Volitelně přidat servisní vrstvu (services/deviceStateService.js) pro práci s instrukcemi, aby kontrolery zůstaly čisté.

4) UX / Admin rozhraní
----------------------
- Nastavení na webu: přidat přepínač "Požadavek na vypnutí" (maps to power_instruction = TURN_OFF).
- Zobrazit aktuální stav zařízení (power_status) .
- V API pro přehled zařízení (getCurrentCoordinates/getDeviceSettings) vracet power_status.

5) Chování při chybách
----------------------
- Pokud handshake přijde od neregistrovaného HW, vrátit registered=false + HTTP 404/200 (dle potřeby) s jasným textem.

6) Doporučený implementační postup
----------------------------------
1. Upravit model Device + migrace (v produkci připravit SQL ALTER, ve vývoji stačí sync alter).
2. Přidat helper na tvorbu odpovědi pro HW (konfigurace + instrukce).
3. Implementovat nový endpoint /api/devices/handshake a otestovat scénáře:
   - registrované zařízení, žádná instrukce,
   - registrované zařízení s pending TURN_OFF,
   - neregistrované zařízení.
4. Rozšířit handleDeviceInput o ack logiku a aktualizaci stavů.
5. Aktualizovat frontend/admin API, aby umělo nastavovat power_instruction a zobrazovat power_status.
6. Uvést do dokumentace (docs_server/3-api-and-routes.md + 7-gps-data-processing.md) nový protokol.

7) Otevřené otázky k doplnění
-----------------------------
- Je potřeba, aby APK následovalo shodný protokol? (zde lze recyklovat handshake endpoint pro APK typ zařízení). --> ANO, sjednoceno přes `/api/devices/handshake`.
