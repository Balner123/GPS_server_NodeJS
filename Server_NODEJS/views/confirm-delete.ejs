<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/_head.ejs', {title: 'Confirm Account Deletion'}) %>
</head>
<body>
    <%- include('partials/_navbar.ejs') %>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Confirm Account Deletion</h4>
                        <p class="mb-3"> Enter the verification code below to confirm the permanent deletion of your account.</p>
                        
                        <% if (error && error.length > 0) { %>
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <% error.forEach(function(msg){ %><p class="mb-0"><%= msg %></p><% }); %>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        <% } %>
                        <% if (success && success.length > 0) { %>
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <% success.forEach(function(msg){ %><p class="mb-0"><%= msg %></p><% }); %>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        <% } %>

                        <form action="/api/settings/confirm-delete" method="POST" id="confirmDeleteForm">
                            <div class="mb-4 text-center">
                                <label class="form-label mb-3" style="font-size:1.2rem;">Verification Code</label>
                                <div style="display:flex; justify-content:center; gap:1rem;">
                                    <input type="text" inputmode="numeric" maxlength="1" pattern="\d" class="form-control code-input" name="code1" required style="width:3rem; height:3rem; font-size:2rem; text-align:center;" />
                                    <input type="text" inputmode="numeric" maxlength="1" pattern="\d" class="form-control code-input" name="code2" required style="width:3rem; height:3rem; font-size:2rem; text-align:center;" />
                                    <input type="text" inputmode="numeric" maxlength="1" pattern="\d" class="form-control code-input" name="code3" required style="width:3rem; height:3rem; font-size:2rem; text-align:center;" />
                                    <input type="text" inputmode="numeric" maxlength="1" pattern="\d" class="form-control code-input" name="code4" required style="width:3rem; height:3rem; font-size:2rem; text-align:center;" />
                                </div>
                            </div>
                            <button type="submit" class="btn btn-danger w-100" style="font-size:1.2rem;">Confirm Deletion</button>
                        </form>
                        <div class="text-center mt-3 d-flex justify-content-center gap-3">
                            <form action="/api/settings/cancel-delete" method="POST">
                                <button type="submit" class="btn btn-secondary">Cancel Deletion</button>
                            </form>
                            <form action="/api/settings/resend-deletion-code" method="POST">
                                <button type="submit" class="btn btn-link">Didnâ€™t receive the code? Resend.</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <%- include('partials/_footer.ejs') %>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Automatic field switching and code concatenation
            document.querySelectorAll('.code-input').forEach((input, idx, arr) => {
                input.addEventListener('input', function(e) {
                    if (this.value.length === 1 && idx < arr.length - 1) {
                        arr[idx + 1].focus();
                    }
                });
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !this.value && idx > 0) {
                        arr[idx - 1].focus();
                    }
                });
            });
            document.getElementById('confirmDeleteForm').addEventListener('submit', function(e) {
                const code = Array.from(document.querySelectorAll('.code-input')).map(i => i.value).join('');
                // Insert the concatenated code into a hidden input
                let hidden = document.getElementById('fullCode');
                if (!hidden) {
                    hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = 'code';
                    hidden.id = 'fullCode';
                    this.appendChild(hidden);
                }
                hidden.value = code;
                // Prevent form submission if code is not 4 digits
                if (!/^\d{4}$/.test(code)) {
                    e.preventDefault();
                    document.querySelectorAll('.code-input').forEach(i => i.classList.add('is-invalid'));
                }
            });
        </script>
</body>
</html>