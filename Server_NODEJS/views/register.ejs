<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/_head.ejs', {title: 'Registrace'}) %>
</head>
<body class="central-body">
    <%- include('partials/_navbar', { currentPage: 'register' }) %>

    <div class="main-container">
        <div class="card login-card">
            <div class="card-body">
                <h3 class="card-title text-center mb-4">Registrace</h3>
                <% if (error) { %>
                    <div class="alert alert-danger"><%= error %></div>
                <% } %>
                <form action="/api/auth/register" method="POST">
                    <div class="mb-3">
                        <label for="username" class="form-label">Uživatelské jméno</label>
                        <input type="text" class="form-control" id="username" name="username" value="<%= input.username || '' %>" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" value="<%= input.email || '' %>" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Heslo</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password" required>
                            <button class="input-group-text border-start-0 bg-white" type="button" id="togglePassword" tabindex="-1" style="border-radius: 0 0.375rem 0.375rem 0; border-left: none; padding: 0 0.75rem;">
                                <i class="fa fa-eye" aria-hidden="true"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Heslo musí mít alespoň 6 znaků, obsahovat alespoň jedno velké písmeno, jedno číslo a jeden speciální znak.
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Potvrzení hesla</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                            <button class="input-group-text border-start-0 bg-white" type="button" id="toggleConfirmPassword" tabindex="-1" style="border-radius: 0 0.375rem 0.375rem 0; border-left: none; padding: 0 0.75rem;">
                                <i class="fa fa-eye" aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="use_weak_password" name="use_weak_password">
                        <label class="form-check-label" for="use_weak_password">Použít slabé heslo (min. 3 znaky)</label>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Register</button>
                    </div>
                </form>
                <div class="text-center mt-3">
                    <p>Máte již účet? <a href="/login">Přihlaste se</a></p>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/_footer') %>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setupHoldToShow('password', 'togglePassword');
            setupHoldToShow('confirmPassword', 'toggleConfirmPassword');

            // --- Client-Side Validation Script ---
            const form = document.querySelector('form');
            const email = document.getElementById('email');
            const password = document.getElementById('password');
            const confirmPassword = document.getElementById('confirmPassword');
            const useWeakPassword = document.getElementById('use_weak_password');
            const submitButton = form.querySelector('button[type="submit"]');

            const passwordRequirements = [
                { regex: /.{6,}/, message: 'Alespoň 6 znaků.' },
                { regex: /[A-Z]/, message: 'Alespoň jedno velké písmeno.' },
                { regex: /[0-9]/, message: 'Alespoň jedno číslo.' },
                { regex: /[^A-Za-z0-9]/, message: 'Alespoň jeden speciální znak.' }
            ];

            function createFeedbackElement(field) {
                let feedback = field.parentElement.querySelector('.invalid-feedback');
                if (!feedback) {
                    feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    const parent = field.parentElement.classList.contains('input-group') ? field.parentElement : field;
                    parent.insertAdjacentElement('afterend', feedback);
                }
                return feedback;
            }

            const emailFeedback = createFeedbackElement(email);
            const passwordFeedback = createFeedbackElement(password);
            const confirmPasswordFeedback = createFeedbackElement(confirmPassword);

            function validateForm() {
                let errors = [];

                const emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
                if (!emailRegex.test(email.value)) {
                    errors.push({ field: email, feedback: emailFeedback, message: 'Zadejte platný email.' });
                } else {
                    email.classList.remove('is-invalid');
                }

                if (useWeakPassword.checked) {
                    if (password.value.length < 3) {
                        errors.push({ field: password, feedback: passwordFeedback, message: 'Slabé heslo musí mít alespoň 3 znaky.' });
                    }
                } else {
                    const unmetReqs = passwordRequirements.filter(req => !req.regex.test(password.value));
                    if (unmetReqs.length > 0) {
                        const message = unmetReqs.map(r => r.message).join(' ');
                        errors.push({ field: password, feedback: passwordFeedback, message: `Heslo nesplňuje: ${message}` });
                    }
                }

                if (password.value !== confirmPassword.value) {
                    errors.push({ field: confirmPassword, feedback: confirmPasswordFeedback, message: 'Hesla se neshodují.' });
                } 

                [email, password, confirmPassword].forEach(f => f.classList.remove('is-invalid'));

                errors.forEach(err => {
                    err.field.classList.add('is-invalid');
                    err.feedback.textContent = err.message;
                });

                submitButton.disabled = errors.length > 0;
            }

            [email, password, confirmPassword, useWeakPassword].forEach(field => {
                field.addEventListener('input', validateForm);
                if (field.type === 'checkbox') field.addEventListener('change', validateForm);
            });

            validateForm();
        });
    </script>
</body>
</html> 