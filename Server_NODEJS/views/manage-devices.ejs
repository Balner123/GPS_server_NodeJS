<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/_head.ejs', {title: 'Device Details'}) %>
</head>
<body>
    <%- include('partials/_preloader.ejs') %>
    <%- include('partials/_navbar.ejs') %>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4 fade-in-on-load" style="animation-delay: 0.2s;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Device List</h5>
                        <a href="/devices" class="btn btn-sm btn-outline-primary" id="device-list-link" style="display: none;">Show All Devices</a>
                    </div>
                    <div class="card-body">
                        <div id="devices-list"></div>
                    </div>
                </div>
                <div class="card mt-4 fade-in-on-load" id="device-settings-card" style="display: none; animation-delay: 0.3s;">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Device Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="device-settings-form">
                            <div class="mb-3">
                                <label for="mode-select" class="form-label">Mode:</label>
                                <select class="form-select" id="mode-select">
                                    <option value="simple">Simple</option>
                                    <option value="batch">Batch</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">GPS Fix Interval (DD:HH:MM:SS):</label>
                                <div class="input-group">
                                    <input type="number" class="form-control text-center" id="interval-gps-days" placeholder="DD" min="0" value="00">
                                    <span class="input-group-text">:</span>
                                    <input type="number" class="form-control text-center" id="interval-gps-hours" placeholder="HH" min="0" max="23" value="00">
                                    <span class="input-group-text">:</span>
                                    <input type="number" class="form-control text-center" id="interval-gps-minutes" placeholder="MM" min="0" max="59" value="00">
                                    <span class="input-group-text">:</span>
                                    <input type="number" class="form-control text-center" id="interval-gps-seconds" placeholder="SS" min="0" max="59" value="00">
                                </div>
                                <div class="form-text">The time interval between each GPS fix attempt.</div>
                            </div>
                            <div class="mb-1" id="batch-settings" style="display: none;">
                                <label for="interval-send" class="form-label">Send Data Interval:</label>
                                <input type="number" class="form-control" id="interval-send" placeholder="Number of cycles" min="1" value="1">
                                <div class="form-text">Send data to server after this many GPS fixes.</div>
                            </div>
                            <div class="mb-1" id="satellites-setting" style="display: none;">
                                <label for="satellites" class="form-label">Minimum Satellites for Fix:</label>
                                <input type="number" class="form-control" id="satellites" placeholder="Number of satellites" min="1" max="50" value="7">
                                <div class="form-text">Minimum number of satellites required for a valid GPS fix.</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </form>
                    </div>
                </div>

                <div class="card mt-4 fade-in-on-load" id="power-control-card" style="display: none; animation-delay: 0.35s;">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Power Control</h5>
                    </div>
                    <div class="card-body">
                        <form id="power-instruction-form" class="mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <button type="button" class="btn btn-danger flex-grow-1" id="power-off-btn">
                                    <i class="fas fa-power-off me-2"></i>Power OFF
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-outline-secondary"
                                    id="clear-power-instruction-btn"
                                    title="Clear pending instruction"
                                >
                                    <i class="fas fa-rotate-right"></i>
                                </button>
                            </div>
                        </form>
                        <div class="power-status-wrapper">
                            <span class="text-uppercase text-muted small d-block mb-1">Status</span>
                            <div class="power-status-chip" id="power-status-chip">
                                <span class="status-dot status-dot--neutral" id="power-status-dot"></span>
                                <span class="power-status-text" id="power-status-text">N/A</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4 fade-in-on-load" id="device-info-card" style="display: none; animation-delay: 0.4s;">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Device Information</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Device ID</dt>
                            <dd class="col-sm-8" id="info-device-id"></dd>
                            <dt class="col-sm-4">Device Type</dt>
                            <dd class="col-sm-8" id="info-device-type"></dd>
                            <dt class="col-sm-4">Registration Date</dt>
                            <dd class="col-sm-8" id="info-registration-date"></dd>
                        </dl>
                        <button id="export-gpx-btn" class="btn btn-success" style="display: none;">Export GPX</button>
                    </div>
                </div>
            </div>
            <div class="col-md-8 fade-in-on-load" style="animation-delay: 0.2s;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Live Map</h5>
                        <div class="d-flex align-items-center">
                            <div class="form-check form-switch me-3">
                                <input class="form-check-input" type="checkbox" role="switch" id="info-toggle-switch" checked>
                                <label class="form-check-label" for="info-toggle-switch">Info</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="cluster-toggle-switch" checked>
                                <label class="form-check-label" for="cluster-toggle-switch">Clusters</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="history-map" style="height: 400px; position: relative;">
                            <div id="map-tool-menu" class="leaflet-bar leaflet-control leaflet-control-custom">
                                <a id="toggle-draw-mode" href="#" title="Create/Edit Geofence"><i class="fas fa-draw-polygon"></i></a>
                                <a id="save-geofence-btn" href="#" title="Save Geofence" style="display: none;"><i class="fas fa-save"></i></a>
                                <a id="delete-geofence-btn" href="#" title="Delete Geofence" style="display: none;"><i class="fas fa-trash"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mt-4 fade-in-on-load" style="animation-delay: 0.2s;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Location History</h5>
                        <button id="toggle-history-btn" class="btn btn-sm btn-outline-primary" style="display: none;">Show All</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Latitude</th>
                                        <th>Longitude</th>
                                        <th>Speed</th>
                                        <th>Altitude</th>
                                        <th>Accuracy</th>
                                        <th>Satellites</th>
                                    </tr>
                                </thead>
                                <tbody id="positions-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/_footer.ejs') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="/js/common.js"></script>
    <script src="/js/device.js"></script>
</body>
</html>