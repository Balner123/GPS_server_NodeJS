<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/_head.ejs', {title: 'Ověření emailu'}) %>
</head>
<body>
    <%- include('partials/_navbar.ejs') %>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                            <h4 class="card-title mb-4"><%= pendingEmailChange ? 'Ověření změny emailu' : 'Ověření emailu' %></h4>
                                                <p class="mb-3">
                                                    <% if (pendingEmailChange) { %>
                                                        Please enter the verification code sent to your email to confirm the email address change.
                                                    <% } else { %>
                                                        To complete your registration, please enter the verification code sent to your email.
                                                    <% } %>
                                                </p>
                        <% if (error && error.length > 0) { %>
                            <div class="alert alert-danger"><%= error[0] %></div>
                        <% } %>
                        <% if (success && success.length > 0) { %>
                            <div class="alert alert-success"><%= success[0] %></div>
                        <% } %>
                                                 <form action="/verify-email" method="POST" id="verifyForm">
                            <div class="mb-4 text-center">
                                <label class="form-label mb-3" style="font-size:1.2rem;">Ověřovací kód</label>
                                <div style="display:flex; justify-content:center; gap:1rem;">
                                    <input type="text" inputmode="numeric" maxlength="1" pattern="\d" class="form-control code-input" name="code1" required style="width:3rem; height:3rem; font-size:2rem; text-align:center;" />
                                    <input type="text" inputmode="numeric" maxlength="1" pattern="\d" class="form-control code-input" name="code2" required style="width:3rem; height:3rem; font-size:2rem; text-align:center;" />
                                    <input type="text" inputmode="numeric" maxlength="1" pattern="\d" class="form-control code-input" name="code3" required style="width:3rem; height:3rem; font-size:2rem; text-align:center;" />
                                    <input type="text" inputmode="numeric" maxlength="1" pattern="\d" class="form-control code-input" name="code4" required style="width:3rem; height:3rem; font-size:2rem; text-align:center;" />
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" style="font-size:1.2rem;">Verify</button>
                        </form>
                        <div class="text-center mt-3">
                            <form action="/resend-verification-from-page" method="POST">
                                <button type="submit" class="btn btn-link">Didn’t receive the code? Resend.</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <%- include('partials/_footer.ejs') %>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Automatic field switching and code concatenation
            document.querySelectorAll('.code-input').forEach((input, idx, arr) => {
                input.addEventListener('input', function(e) {
                    if (this.value.length === 1 && idx < arr.length - 1) {
                        arr[idx + 1].focus();
                    }
                });
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !this.value && idx > 0) {
                        arr[idx - 1].focus();
                    }
                });
            });
            document.getElementById('verifyForm').addEventListener('submit', function(e) {
                const code = Array.from(document.querySelectorAll('.code-input')).map(i => i.value).join('');
                // Insert the concatenated code into a hidden input
                let hidden = document.getElementById('fullCode');
                if (!hidden) {
                    hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = 'code';
                    hidden.id = 'fullCode';
                    this.appendChild(hidden);
                }
                hidden.value = code;
                // Prevent form submission if code is not 4 digits
                if (!/^\d{4}$/.test(code)) {
                    e.preventDefault();
                    document.querySelectorAll('.code-input').forEach(i => i.classList.add('is-invalid'));
                }
            });
        </script>
</body>
</html>
