<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/_head.ejs', { title: 'Administration' }) %>
</head>
<body>
    <%- include('partials/_navbar.ejs') %>

    <div class="container-fluid py-4">
        <h2 class="mb-4">Database Administration</h2>

        <% const errorMsg = Array.isArray(error) ? error[0] : error; %>
        <% if (errorMsg) { %>
            <div class="alert alert-danger" role="alert">
                <%= errorMsg %>
            </div>
        <% } %>
        <% const successMsg = Array.isArray(success) ? success[0] : success; %>
        <% if (successMsg) { %>
            <div class="alert alert-success" role="alert">
                <%= successMsg %>
            </div>
        <% } %>

        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Users (<%= users.length %>)</h3>
                <button id="usersToggle" class="btn btn-sm btn-outline-primary" data-table-toggle="usersTable" data-total="<%= users.length %>">Show All</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-sm" id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Verified</th>
                            <th>Provider</th>
                            <th>Provider ID</th>
                            <th>Pending Email</th>
                            <th>Password Hash</th>
                            <th>Devices</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% users.forEach(user => { %>
                            <tr>
                                <td><%= user.id %></td>
                                <td><%= user.username %></td>
                                <td><%= user.email %></td>
                                <td><%= user.is_verified ? 'Yes' : 'No' %></td>
                                <td><%= user.provider || '' %></td>
                                <td><%= user.provider_id || '' %></td>
                                <td><%= user.pending_email || '' %></td>
                                <td style="font-size: 0.75em; word-break: break-all;"><%= user.password %></td>
                                <td><%= user.devices ? user.devices.length : 0 %></td>
                                <td><%= new Date(user.created_at).toLocaleString() %></td>
                                <td>
                                    <% if (user.username !== 'root') { %>
                                        <form action="/api/admin/delete-user/<%= user.id %>" method="POST" onsubmit="return confirm('Delete this user and all related data?');">
                                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                        </form>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Devices (<%= devices.length %>)</h3>
                <button id="devicesToggle" class="btn btn-sm btn-outline-primary" data-table-toggle="devicesTable" data-total="<%= devices.length %>">Show All</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-sm" id="devicesTable">
                    <thead>
                        <tr>
                            <th>Device ID</th>
                            <th>Name</th>
                            <th>Owner</th>
                            <th>Power Status</th>
                            <th>Instruction</th>
                            <th>GPS Interval</th>
                            <th>Send Interval</th>
                            <th>Satellites</th>
                            <th>Mode</th>
                            <th>Last Seen</th>
                            <th>Geofence</th>
                            <th>Actions</th>
                            
                        </tr>
                    </thead>
                    <tbody>
                        <% devices.forEach(device => { %>
                            <tr>
                                <td><code><%= device.device_id %></code></td>
                                <td><%= device.name || 'N/A' %></td>
                                <td><%= device.User ? device.User.username : 'N/A' %></td>
                                <td><%= (device.power_status || 'UNKNOWN').toUpperCase() %></td>
                                <td><%= (device.power_instruction || 'NONE').toUpperCase() %></td>
                                <td><%= device.interval_gps %>s</td>
                                <td><%= device.interval_send %>s</td>
                                <td><%= device.satellites %></td>
                                <td><%= device.mode %></td>
                                <td><%= device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never' %></td>
                                <td><%= device.geofence || 'N/A' %></td>
                                <td>
                                    <form action="/api/admin/delete-device/<%= device.id %>" method="POST" onsubmit="return confirm('Delete this device and all related data?');">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Latest Locations (<%= locations.length %>)</h3>
                <button id="locationsToggle" class="btn btn-sm btn-outline-primary" data-table-toggle="locationsTable" data-total="<%= locations.length %>">Show All</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-sm" id="locationsTable">
                    <thead>
                        <tr>
                            <th>Device ID</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Speed</th>
                            <th>Altitude</th>
                            <th>Accuracy</th>
                            <th>Satellites</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% locations.forEach(location => { %>
                            <tr>
                                <td><code><%= location.Device ? location.Device.device_id : '' %></code></td>
                                <td><%= location.latitude %></td>
                                <td><%= location.longitude %></td>
                                <td><%= location.speed != null ? location.speed : 'N/A' %></td>
                                <td><%= location.altitude != null ? location.altitude : 'N/A' %></td>
                                <td><%= location.accuracy != null ? location.accuracy : 'N/A' %></td>
                                <td><%= location.satellites != null ? location.satellites : 'N/A' %></td>
                                <td><%= new Date(location.timestamp).toLocaleString() %></td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Alerts (<%= alerts.length %>)</h3>
                <button id="alertsToggle" class="btn btn-sm btn-outline-primary" data-table-toggle="alertsTable" data-total="<%= alerts.length %>">Show All</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-sm" id="alertsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Device ID</th>
                            <th>User</th>
                            <th>Type</th>
                            <th>Message</th>
                            <th>Read</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% alerts.forEach(alert => { %>
                            <tr>
                                <td><%= alert.id %></td>
                                <td><code><%= alert.Device ? alert.Device.device_id : '' %></code></td>
                                <td><%= alert.User ? alert.User.username : '' %></td>
                                <td><%= alert.type %></td>
                                <td><%= alert.message %></td>
                                <td><%= alert.is_read ? 'Yes' : 'No' %></td>
                                <td><%= new Date(alert.created_at).toLocaleString() %></td>
                                <td>
                                    <form action="/api/admin/delete-alert/<%= alert.id %>" method="POST" onsubmit="return confirm('Delete this alert?');">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <%- include('partials/_footer.ejs') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const ROW_LIMIT = 7;

        function setupTableLimit(tableId, toggleBtn, totalCount) {
            const table = document.getElementById(tableId);
            if (!table || !toggleBtn) {
                return;
            }

            const rows = Array.from(table.querySelectorAll('tbody tr'));
            if (rows.length <= ROW_LIMIT) {
                toggleBtn.style.display = 'none';
                return;
            }

            let showAll = false;

            const applyLimit = () => {
                rows.forEach((row, index) => {
                    row.style.display = (showAll || index < ROW_LIMIT) ? '' : 'none';
                });
                toggleBtn.textContent = showAll ? 'Show Less' : `Show All (${totalCount})`;
            };

            toggleBtn.addEventListener('click', () => {
                showAll = !showAll;
                applyLimit();
            });

            applyLimit();
        }

        document.querySelectorAll('[data-table-toggle]').forEach((btn) => {
            const tableId = btn.dataset.tableToggle;
            const total = Number(btn.dataset.total || 0);
            setupTableLimit(tableId, btn, total);
        });
    });
    </script>
</body>
</html>