===================================
APK Communication Requirements
===================================

1) Auth & Session
------------------
- APK klient využívá existující login endpoint (`POST /api/apk/login`).
- Účet musí být ověřený (flag `user.is_verified=true`), jinak login vrací `403`.
- Session cookie je potřeba pro všechny uživatelské akce (registrace zařízení, správa účtu). Handshake a telemetrie běží nezávisle na session – autentizují se pouze `device_id`.
- Logout (`POST /api/apk/logout`) ruší session a musí být volán před odinstalací, aby nevisel záznam v DB.
- Další komunikace napodobuje HW klienta; APK i HW sdílejí stejné endpointy a odpovědi.

2) Registrace zařízení
----------------------
- Endpoint: `POST /api/devices/register` (sjednocený).
- Payload minimálně:
  {
    "client_type": "APK",
    "device_id": "installationId",
    "name": "optional alias"
  }
- Server ověřuje session (uživatel přihlášen) a mapuje `installationId` na `device.device_id`.
- Odpověď: `{ success: true, message?, already_registered? }`.
- Při dvojité registraci musí server vrátit 200 se stavem `already_registered=true`.

3) Handshake / konfigurace
--------------------------
- Endpoint: `POST /api/devices/handshake`.
- Request musí nést `device_id`, `client_type: APK` a aktuální `power_status` (`ON|OFF`). Doporučené doplňky: `app_version`, `battery`, `uptime`.
- Server vždy vrací 200. Pokud zařízení neexistuje, payload má `registered=false` a klient by měl nabídnout registraci.
- Standardní response:
  {
    "registered": true,
    "config": {
      "interval_gps": <int>,
      "interval_send": <int>,
      "satellites": <int>,
      "mode": "simple|batch"
    },
    "power_instruction": "NONE" | "TURN_OFF"
  }
- APK klient musí instrukci interpretovat stejně jako HW – po obdržení `TURN_OFF` přejít do režimu vypnutí/sleep a na další telemetrii hlásit `power_status="OFF"`.
- `power_instruction` se automaticky resetuje na `NONE`, jakmile server obdrží telemetrii s odpovídajícím `power_status` (např. `TURN_OFF` + `power_status=OFF`).

- Endpoint: `POST /api/devices/input`.
- Payload formát identický s HW (podpora jednotlivého objektu i pole):
  {
    "device": "installationId",
    "latitude": <float>,
    "longitude": <float>,
    "accuracy": <float>,
    "speed": <float>,
    "timestamp": <ISO string>,
    "power_status": "ON|OFF",
    "client_type": "APK"
  }
- Povinná pole: `device`, `latitude`, `longitude`.
- Volitelná pole: `accuracy`, `speed`, `altitude`, `error`.
- Pokud došlo k přepnutí do režimu vypnutí, `power_status` musí být `OFF`, aby server mohl instrukci nulovat.
- Server odpovídá JSONem:
  {
    "success": true
  }

4) Validace telemetrie (middleware/validators.js)
-------------------------------------------------
`POST /api/devices/input` i HW logika sdílí stejný validátor. Požadavek je odmítnut (HTTP 400) s chybovou strukturou `{ error: 'Invalid device payload', details: [...] }`, pokud některá z hodnot nesplní následující podmínky:

| Pole          | Povinnost | Přijatelný rozsah / formát                                   |
| ------------- | --------- | ------------------------------------------------------------ |
| `device`      | povinné   | Neprázdný řetězec (na prvním datovém bodě v payloadu).       |
| `latitude`    | povinné   | Číslo od `-90.0` do `90.0`.                                   |
| `longitude`   | povinné   | Číslo od `-180.0` do `180.0`.                                 |
| `speed`       | volitelné | Číslo v km/h, `0` – `1000`.                                   |
| `altitude`    | volitelné | Číslo v metrech, `-1000` – `10000`.                           |
| `satellites`  | volitelné | Celé číslo `0` – `50`.                                        |
| `accuracy`    | volitelné | Vstup se přijímá, doporučeno `0` – `100` (využito pro UI, kontrola je momentálně vypnutá). |

- Payload může být jeden objekt **nebo** pole objektů. Validátor normalizuje tělo na pole a vyhodnotí každý bod.
- Maximální délky surových těles zpráv jsou dále omezovány loggerem proměnnou `LOGGER_MAX_BODY_LENGTH` (výchozí 8192 B).

5) Error handling
-----------------
- 401 → session vypršela, APK musí uživatele přesměrovat na login.
- 404 s `registered=false` → zařízení není registrováno, nabídnout registraci.
- 500 → logovat a retry strategii s exponenciálním backoffem.

6) Telemetrie klienta
---------------------
- Min. logování: počet uložených bodů před odesláním, důvody neodeslaných dat.

7) Bezpečnostní poznámky
------------------------
- Přenášet pouze přes HTTPS.
