# Plán refaktoringu

## Fáze 1: Centralizace síťové komunikace

**Cíl**: Odstranit duplicitní kód pro `HttpURLConnection` a sjednotit veškerou HTTP komunikaci do jedné centrální komponenty.

1.  **Vytvoření `ApiClient.kt`**:
    *   Vytvořit novou třídu/objekt `ApiClient`, který bude zodpovědný za veškerou komunikaci se serverem.
    *   Implementovat v něm interní generickou `suspend` funkci, která se postará o:
        *   Vytvoření `HttpURLConnection`.
        *   Nastavení metody, timeoutů a společných hlaviček.
        *   Zápis těla požadavku.
        *   Zpracování odpovědi, včetně chybových stavů (4xx, 5xx).
        *   Vyvolání specifických výjimek (např. `UnauthorizedException`) pro srozumitelnější zpracování chyb.
        *   Parsování JSON odpovědi pomocí Gson.
    *   Vystavit veřejné `suspend` funkce pro každý endpoint (`login`, `registerDevice`, `sendHandshake`, `sendBatch`, `logout`).

2.  **Refaktoring `LoginActivity.kt`**:
    *   Nahradit stávající logiku s `HttpURLConnection` pro přihlášení a registraci za volání metod z `ApiClient`.

3.  **Refaktoring `MainActivity.kt`**:
    *   Nahradit logiku v metodě `sendLogoutRequest` za volání metody `logout` z `ApiClient`.

4.  **Refaktoring `HandshakeManager.kt`**:
    *   Upravit metodu `executeHandshake` tak, aby místo přímého vytváření spojení volala `sendHandshake` z `ApiClient`.

5.  **Refaktoring `SyncWorker.kt`**:
    *   Nahradit metodu `postBatch` za volání metody `sendBatch` z `ApiClient`. Zjednoduší se tím i zpracování chyb.

## Fáze 2: Náhrada `LocalBroadcastManager` za `StateFlow`

**Cíl**: Nahradit zastaralý `LocalBroadcastManager` moderním a reaktivním přístupem pomocí `StateFlow` pro komunikaci mezi `LocationService` a `MainActivity`.

1.  **Vytvoření `ServiceStateRepository.kt`**:
    *   Vytvořit nový singleton `object` `ServiceStateRepository`.
    *   Uvnitř definovat `private MutableStateFlow<ServiceState>` pro držení aktuálního stavu služby.
    *   Vystavit veřejnou, neměnnou `StateFlow<ServiceState>`, ze které budou moci ostatní části aplikace číst.
    *   Přidat metodu `updateState(newState: ServiceState)`, kterou bude volat `LocationService`.

2.  **Refaktoring `LocationService.kt`**:
    *   V metodě `updateAndBroadcastState` nahradit volání `LocalBroadcastManager.sendBroadcast(...)` za `ServiceStateRepository.updateState(...)`.
    *   Kompletně odstranit kód související s `LocalBroadcastManager` a broadcast receivery z této třídy.

3.  **Refaktoring `MainActivity.kt`**:
    *   Odstranit `statusReceiver` (instanci `BroadcastReceiver`).
    *   Odstranit registraci a odregistraci receiveru v `onResume` a `onPause`.
    *   V `onCreate` pomocí `lifecycleScope` začít odebírat (`collect`) data z `ServiceStateRepository.stateFlow`.
    *   Při každé změně (nové emisi `ServiceState`) zavolat metodu `updateUiState`, která aktualizuje UI. Zajistit, aby byl odběr vázaný na životní cyklus (např. pomocí `repeatOnLifecycle`).
