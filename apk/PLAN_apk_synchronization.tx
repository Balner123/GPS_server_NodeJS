PLAN: APK Synchronization With Server Expectations
===============================================

Objective
---------
Establish a concrete roadmap to align the APK implementation with the updated server-side communication contract, focusing on power state signaling, handshake flows, and telemetry parity with HW devices.

Phase 1 – Contract Audit & Prerequisites
----------------------------------------
1. Confirm server endpoints, payload schemas, and authentication flow against `docs_apk/*` and `APK_comm_requirements.txt`.
2. Document current APK request/response bodies (login, register, input) to highlight deltas – especially missing `client_type` and `power_status` fields.
3. Define a persistent representation for device power state (e.g., enum `ON/OFF` stored in SharedPreferences) to be shared across services and workers.

Phase 2 – Registration & Identity Alignment
-------------------------------------------
1. Update registration call to target `/api/devices/register` with payload `{ client_type: "APK", device_id: installationId, name: <alias> }`.
2. Ensure login flow stores `client_type="APK"` and `device_id` needed for subsequent handshake/input requests.

Phase 3 – Handshake Lifecycle
-----------------------------
1. Introduce a `HandshakeManager` (or equivalent coroutine helper) responsible for:
   - Posting `POST /api/devices/handshake` with `{ device_id, client_type: "APK", power_status, app_version, platform }`.
   - Parsing response `{ registered, config, power_instruction }`.
2. Call handshake on key lifecycle events:
   - After successful login / registration.
   - When `LocationService` starts or resumes.
   - On scheduled intervals if defined by backend (fallback: before each sync batch).
3. Handle response:
   - If `registered=false`, broadcast an action prompting UI to request re-registration.
   - Apply any `config` deltas (intervals, mode, satellites) via SharedPreferences.
   - React to `power_instruction="TURN_OFF"` by stopping tracking and persisting `power_status="OFF"` for subsequent sends.

Phase 4 – Power State Tracking & Telemetry
------------------------------------------
1. Extend `ServiceState`, `CachedLocation`, and related DAO schema to include `powerStatus` (default `ON`). Apply Room migration strategy.
2. Ensure `LocationService` updates the shared power state:
   - `ON` when service starts or restarts normally.
   - `OFF` when stopped due to server instruction or user action.
3. When user manually stops tracking, enqueue an immediate handshake/input flush marking `power_status="OFF"` to reset server instructions.
4. Augment log output to record every power state transition for diagnostics.

Phase 5 – Payload Compliance for `/api/devices/input`
----------------------------------------------------
1. Modify `SyncWorker` payload builder to include per-point fields:
   - `client_type="APK"`.
   - `power_status` from persisted value or per-record column.
2. After successful batch send, interpret server response (even for small batches):
   - Apply `interval_gps`, `interval_send`, and future extensions safely.
   - Monitor for `power_instruction` in the response to allow mid-batch shutdowns.
3. Confirm retry/backoff logic respects power state (e.g., do not flip back to `ON` after failure).

Phase 6 – UI & User Feedback
-----------------------------
2. Provide a clear banner/toast when the server issues `TURN_OFF`, differentiating from user-initiated stops.
3. Ensure logout flow sends `POST /api/apk/logout` and clears tracked power state.

Phase 8 – Documentation & Release Prep
---------------------------------------
1. update /docs_apk with actualized documents

Completion Criteria
-------------------
- All server endpoints receive payloads that meet documented schemas.
- APK correctly toggles and reports `power_status` for both manual and remote shutdowns.
- Handshake flow reliably applies server-provided configuration and power instructions.
- Documentation reflects the implemented behavior and QA validates critical paths.
