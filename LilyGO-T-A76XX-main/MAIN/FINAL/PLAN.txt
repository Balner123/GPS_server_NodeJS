# Plán pro Refaktor a Spojení Funkcionality GPS Trackeru

**Cíl:** Vytvořit stabilní, modulární a funkční firmware pro GPS tracker spojením logiky z `gps_tracker_history.ino` (GPS/GPRS/OTA) a `button_logic_test.ino` (správa napájení a tlačítek). Výsledný kód bude v adresáři `FINAL/` a bude následovat osvědčené postupy pro čitelnost a údržbu.

---

### Fáze 1: Základní Struktura a Správa Napájení

1.  **Vytvoření základních souborů:**
    *   `main.ino`: Hlavní vstupní bod aplikace. Bude obsahovat `setup()` a `loop()`.
    *   `power_management.h` / `.cpp`: Veškerá logika související s napájením a tlačítkem.
        *   Funkce pro inicializaci (`power_init()`).
        *   Funkce pro zapnutí/vypnutí (`power_on()`, `power_off()`).
        *   Obsluha tlačítka (krátký stisk, dlouhý stisk).
        *   Vstup do hlubokého spánku (`enter_deep_sleep()`).
    *   `ota_mode.h` / `.cpp`: Logika pro OTA (Over-the-Air) aktualizace.
        *   Funkce `start_ota_mode()`, která spustí WiFi AP a webový server.
    *   `config.h`: Centrální místo pro všechny definice pinů, konstant a konfiguračních parametrů (názvy APN, server, atd.).

2.  **Implementace správy napájení:**
    *   Přenést logiku z `button_logic_test.ino` do `power_management.cpp`.
    *   Použít FreeRTOS task (`ShutdownTask`) pro spolehlivé vypnutí zařízení po stisku tlačítka.
    *   V `setup()` v `main.ino` inicializovat piny (`PIN_EN`, `PIN_BTN`) a spustit `ShutdownTask`.
    *   **Logika tlačítka:**
        *   **Krátký stisk:** Okamžitě zavolá `graceful_shutdown()` (přejmenováno z `gracefulShutdownAndPowerOff`).
        *   **Dlouhý stisk při zapnutí (z OFF stavu):** Detekovat v `setup()`. Pokud je tlačítko drženo déle než 3 sekundy při startu, přejde se do OTA režimu.
        *   **Dlouhý stisk za běhu:** Ignorovat nebo definovat specifickou akci (prozatím ignorovat).

---

### Fáze 2: Modularizace Funkcí Trackeru

1.  **Rozdělení `gps_tracker_history.ino`:**
    *   **`gps_control.h` / `.cpp`:**
        *   Funkce pro práci s GPS modulem: `power_up_gps()`, `power_down_gps()`, `get_gps_fix()`.
        *   Přenést logiku z `waitForGPSFix` a souvisejících funkcí.
    *   **`modem_control.h` / `.cpp`:**
        *   Funkce pro komunikaci s modemem A7670E: `modem_init()`, `modem_connect_gprs()`, `modem_send_data()`, `modem_disconnect()`, `modem_power_off()`.
        *   Zpracování AT příkazů a správa GPRS spojení.
    *   **`file_system.h` / `.cpp`:**
        *   Funkce pro práci se souborovým systémem LittleFS a `Preferences`.
        *   `fs_init()`, `cache_data()`, `read_cached_data()`, `clear_cache()`.
        *   Správa konfigurace (čtení/zápis z/do `Preferences`).
    *   **`ota_mode.h` / `.cpp`:**
        *   Přenést veškerý kód související s OTA z `gps_tracker_history.ino`.
        *   HTML kód stránek přesunout do samostatného souboru (např. `ota_pages.h`) pro lepší přehlednost.

2.  **Refaktor a odstranění globálních proměnných:**
    *   Místo `extern` proměnných vytvořit `struct` (např. `DeviceState` nebo `AppContext`), který bude obsahovat stav zařízení (GPS souřadnice, stav modemu atd.).
    *   Předávat ukazatel na tento `struct` funkcím, které ho potřebují. Tím se zvýší modularita a přehlednost.

---

### Fáze 3: Spojení a Finalizace

1.  **Integrace v `main.ino`:**
    *   **`setup()`:**
        1.  Volat `power_on()` (drží `PIN_EN` na `HIGH`).
        2.  Inicializovat sériovou komunikaci.
        3.  Zkontrolovat dlouhý stisk pro OTA režim. Pokud ano, volat `start_ota_mode()` a `loop()` se nikdy nespustí.
        4.  Pokud ne, pokračovat v normálním režimu.
        5.  Inicializovat souborový systém (`fs_init()`).
        6.  Načíst konfiguraci.
        7.  Inicializovat power management (`power_init()`, spuštění `ShutdownTask`).
        8.  Spustit hlavní pracovní cyklus (`work_cycle()`).
        9.  Po dokončení cyklu zavolat `enter_deep_sleep()`.
    *   **`loop()`:** Zůstane prázdný, protože logika je řízena probouzením z deep sleep.
    *   **`work_cycle()` (nová funkce):**
        1.  Získat GPS data (`get_gps_fix()`).
        2.  Pokud jsou data validní, uložit je do mezipaměti (`cache_data()`).
        3.  Zkontrolovat, zda je čas odeslat data (např. plná mezipaměť).
        4.  Pokud ano, inicializovat modem, připojit se k GPRS, odeslat data a odpojit se.
        5.  Uklidit (vypnout periferie, které nejsou potřeba).

2.  **Čistý Shutdown:**
    *   Funkce `graceful_shutdown()` v `power_management.cpp` musí zajistit bezpečné ukončení všech operací:
        1.  Odpojit GPRS.
        2.  Vypnout modem.
        3.  Vypnout GPS.
        4.  Ukončit práci s LittleFS.
        5.  Nakonec shodit `PIN_EN` na `LOW`.

---
### Struktura souborů v `FINAL/`:
```
FINAL/
├── main.ino
├── config.h
├── power_management.h
├── power_management.cpp
├── gps_control.h
├── gps_control.cpp
├── modem_control.h
├── modem_control.cpp
├── file_system.h
├── file_system.cpp
├── ota_mode.h
├── ota_mode.cpp
├── ota_pages.h
└── utilities.h
```
Tento plán zajistí, že výsledný kód bude robustní, snadno rozšiřitelný a bude správně implementovat požadovanou funkcionalitu tlačítek a správy napájení.
